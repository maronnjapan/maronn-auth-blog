---
import DashboardLayout from '../../layouts/DashboardLayout.astro';
import NotificationList from '../../islands/NotificationList';

const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

// Get session cookie from request
const cookie = Astro.request.headers.get('cookie') || '';
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 20;

let notifications = [];
let total = 0;
let hasMore = false;
let error = null;

try {
  const response = await fetch(`${API_URL}/dashboard/notifications?page=${page}&limit=${limit}`, {
    headers: {
      Cookie: cookie,
    },
  });

  if (response.ok) {
    const data = await response.json();
    notifications = data.notifications || [];
    total = data.total || 0;
    hasMore = data.hasMore || false;
  } else if (response.status === 401) {
    return Astro.redirect(`${API_URL}/auth/login`);
  } else {
    error = '通知の取得に失敗しました';
  }
} catch (err) {
  error = '通知の取得に失敗しました';
  console.error('Failed to fetch notifications:', err);
}
---

<DashboardLayout title="通知">
  {error ? (
    <div class="error">
      <p>{error}</p>
    </div>
  ) : (
    <NotificationList
      notifications={notifications}
      total={total}
      page={page}
      limit={limit}
      hasMore={hasMore}
      apiUrl={API_URL}
      client:load
    />
  )}
</DashboardLayout>

<style>
  .error {
    text-align: center;
    padding: 3rem 1rem;
    background: white;
    border-radius: 8px;
    color: #f44336;
  }
</style>
