---
// This page is pre-rendered at build time (SSG) to use zenn-markdown-html
// which requires Node.js built-in modules not available in Cloudflare Workers
export const prerender = true;

import BaseLayout from "../../layouts/BaseLayout.astro";
import markdownToHtmlImport from "zenn-markdown-html";
import "zenn-content-css";
import guideContent from "../../content/guide/usage.md?raw";

type MarkdownToHtmlFn = (markdown: string, options?: { embedOrigin?: string }) => string;

const markdownToHtml: MarkdownToHtmlFn =
  typeof markdownToHtmlImport === "function"
    ? (markdownToHtmlImport as MarkdownToHtmlFn)
    : ((markdownToHtmlImport as { default: MarkdownToHtmlFn }).default as MarkdownToHtmlFn);

let htmlContent = "";

try {
  // Convert Markdown to HTML using zenn-markdown-html
  htmlContent = markdownToHtml(guideContent, { embedOrigin: import.meta.env.PUBLIC_EMBED_ORIGIN || "" });
} catch (error) {
  console.error("Failed to parse markdown:", error);
  htmlContent = "<p>コンテンツの読み込みに失敗しました。</p>";
}
---

<BaseLayout title="使い方ガイド - Auth Vault">
  <div class="guide-container">
    <article class="guide-content znc" set:html={htmlContent} />

    <div class="back-link">
      <a href="/guide">ガイド一覧に戻る</a>
      <span class="separator">|</span>
      <a href="/">トップページに戻る</a>
    </div>
  </div>

  <!-- Script to handle embed iframe messages (similar to zenn's listen-embed-event.js) -->
  <script is:inline>
    (function() {
      window.addEventListener('message', function(event) {
        var data = event.data;
        if (!data || typeof data !== 'object') return;

        // Handle request-content message from embed iframe
        if (data.type === 'request-content' && data.id) {
          var iframe = document.querySelector('iframe[src*="#' + data.id + '"]');
          if (iframe) {
            var content = iframe.getAttribute('data-content');
            if (content && iframe.contentWindow) {
              iframe.contentWindow.postMessage({
                type: 'content',
                id: data.id,
                content: decodeURIComponent(content)
              }, '*');
            }
          }
        }

        // Handle height adjustment message from embed iframe
        if (data.id && typeof data.height === 'number') {
          var iframe = document.querySelector('iframe[src*="#' + data.id + '"]');
          if (iframe) {
            iframe.style.height = data.height + 'px';
          }
        }
      });
    })();
  </script>
</BaseLayout>

<style>
  .guide-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 1rem;
    overflow-x: hidden;
  }

  .guide-content {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    max-width: 100%;
    overflow-x: hidden;
  }

  .guide-content :global(.znc) {
    max-width: 100%;
    overflow-x: hidden;
    overflow-wrap: break-word;
    word-break: break-word;
  }

  .guide-content :global(.znc img) {
    max-width: 100%;
    height: auto;
    display: block;
  }

  .guide-content :global(.znc table) {
    max-width: 100%;
    overflow-x: auto;
    display: block;
  }

  .guide-content :global(.znc pre) {
    max-width: 100%;
    overflow-x: auto;
  }

  .guide-content :global(.znc iframe) {
    max-width: 100%;
  }

  .guide-content :global(.znc code) {
    word-break: break-all;
  }

  .back-link {
    text-align: center;
    padding: 2rem 0;
  }

  .back-link a {
    color: #0066cc;
    text-decoration: none;
  }

  .back-link a:hover {
    text-decoration: underline;
  }

  .separator {
    margin: 0 1rem;
    color: #ccc;
  }

  @media (max-width: 768px) {
    .guide-content {
      padding: 1.5rem;
    }
  }
</style>
