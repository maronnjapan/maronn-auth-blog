---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import CommentSection from '../../../islands/CommentSection';
import TableOfContents from '../../../islands/TableOfContents';
import MobileTableOfContents from '../../../islands/MobileTableOfContents';
import { getTargetCategoryMeta } from '../../../lib/target-categories';
import { extractTocItems, getBaseLevel, buildNestedToc } from '../../../lib/toc';
import type { TargetCategory } from '@maronn-auth-blog/shared';
import 'zenn-content-css';

const { username, slug } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';
const cookie = Astro.request.headers.get('Cookie') || '';

// Fetch article data
let article = null;
let error = null;

try {
  const response = await fetch(`${API_URL}/articles/${username}/${slug}`);
  if (response.ok) {
    article = await response.json();
  } else {
    error = '記事が見つかりません';
  }
} catch (err) {
  error = '記事の取得に失敗しました';
}

if (error || !article) {
  return Astro.redirect('/404');
}

// Fetch current user for comment section
let currentUser = null;
try {
  const userResponse = await fetch(`${API_URL}/auth/me`, {
    credentials: 'include',
    headers: { Cookie: cookie },
  });
  if (userResponse.ok) {
    currentUser = await userResponse.json();
  }
} catch {
  // Not logged in
}

// Fetch comments for this article
let commentsData = { comments: [] as any[], total: 0 };
try {
  const commentsResponse = await fetch(`${API_URL}/comments/articles/${article.id}`);
  if (commentsResponse.ok) {
    commentsData = await commentsResponse.json();
  }
} catch {
  // Failed to fetch comments
}

const publishedDate = new Date(article.publishedAt).toLocaleDateString('ja-JP', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});
const authorName = article.author?.displayName ?? username;

// Extract TOC items from article HTML
const tocItems = extractTocItems(article.html || '');
const baseLevel = getBaseLevel(tocItems);
const nestedTocItems = buildNestedToc(tocItems);
const hasToc = tocItems.length > 0;
---

<BaseLayout title={`${article.title} - ${username}`}>
  <div class={`article-page ${hasToc ? 'has-toc' : ''}`}>
    <article class="article">
      <header class="article-header">
        <h1>{article.title}</h1>
        <div class="article-meta">
          <a href={`/${username}`} class="author">{authorName}</a>
          <time datetime={article.publishedAt}>{publishedDate}</time>
          {article.category && (
            <span class="category">{article.category}</span>
          )}
        </div>
        {article.targetCategories && article.targetCategories.length > 0 && (
          <div class="target-categories">
            <span class="target-categories-label">対象カテゴリ</span>
            <div class="target-category-list">
              {article.targetCategories.map((category: TargetCategory) => {
                const { icon, label, key } = getTargetCategoryMeta(category);
                return (
                  <span class="target-category" key={key}>
                    <span class="icon" aria-hidden="true">{icon}</span>
                    <span>{label}</span>
                  </span>
                );
              })}
            </div>
          </div>
        )}
        {article.topics && article.topics.length > 0 && (
          <div class="topics">
            {article.topics.map((topic: string) => (
              <a class="topic" href={`/?topic=${encodeURIComponent(topic)}`}>#{topic}</a>
            ))}
          </div>
        )}
      </header>

      {hasToc && (
        <div class="mobile-toc-wrapper">
          <MobileTableOfContents items={nestedTocItems} baseLevel={baseLevel} client:load />
        </div>
      )}

      <div class="znc" set:html={article.html} />

      <CommentSection
        articleId={article.id}
        initialComments={commentsData.comments}
        initialTotal={commentsData.total}
        currentUser={currentUser}
        apiUrl={API_URL}
        client:load
      />
    </article>

    {hasToc && (
      <aside class="toc-sidebar">
        <TableOfContents items={nestedTocItems} baseLevel={baseLevel} client:load />
      </aside>
    )}
  </div>

  <!-- Script to handle embed iframe messages (similar to zenn's listen-embed-event.js) -->
  <script is:inline>
    (function() {
      window.addEventListener('message', function(event) {
        var data = event.data;
        if (!data || typeof data !== 'object') return;

        // Handle request-content message from embed iframe
        if (data.type === 'request-content' && data.id) {
          var iframe = document.querySelector('iframe[src*="#' + data.id + '"]');
          if (iframe) {
            var content = iframe.getAttribute('data-content');
            if (content && iframe.contentWindow) {
              iframe.contentWindow.postMessage({
                type: 'content',
                id: data.id,
                content: decodeURIComponent(content)
              }, '*');
            }
          }
        }

        // Handle height adjustment message from embed iframe
        if (data.id && typeof data.height === 'number') {
          var iframe = document.querySelector('iframe[src*="#' + data.id + '"]');
          if (iframe) {
            iframe.style.height = data.height + 'px';
          }
        }
      });
    })();
  </script>

</BaseLayout>

<style>
  .article-page {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
    overflow-x: hidden;
  }

  .article-page.has-toc {
    max-width: 1120px;
    display: grid;
    grid-template-columns: minmax(0, 1fr) 240px;
    gap: 2.5rem;
    align-items: start;
    overflow-x: visible;
  }

  .article {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    max-width: 100%;
    overflow-x: hidden;
    min-width: 0;
  }

  .article-header {
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 1.5rem;
    margin-bottom: 2rem;
  }

  .article-header h1 {
    font-size: 2.5rem;
    line-height: 1.3;
    margin-bottom: 1rem;
  }

  .article-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
    color: #666;
    font-size: 0.9rem;
    flex-wrap: wrap;
  }

  .author {
    color: #0066cc;
    text-decoration: none;
    font-weight: 500;
  }

  .author:hover {
    text-decoration: underline;
  }

  .category {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
  }

  .topics {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
    flex-wrap: wrap;
    max-width: 100%;
    overflow: hidden;
  }

  .topic {
    background: #f5f5f5;
    color: #666;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.85rem;
    text-decoration: none;
    display: inline-block;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .topic:hover {
    background: #e9eef4;
    color: #333;
  }

  .target-categories {
    margin-top: 1rem;
  }

  .target-categories-label {
    font-size: 0.85rem;
    color: #666;
    margin-right: 0.5rem;
  }

  .target-category-list {
    display: inline-flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  .target-category {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: #f5f7fb;
    border: 1px solid #e1e7f0;
    border-radius: 999px;
    padding: 0.25rem 0.75rem;
    font-size: 0.85rem;
    color: #445;
  }

  .target-category .icon {
    font-size: 1rem;
    line-height: 1;
  }

  .article :global(.znc) {
    max-width: 100%;
    overflow-x: hidden;
    overflow-wrap: break-word;
    word-break: break-word;
  }

  .article :global(.znc img) {
    max-width: 100%;
    height: auto;
    display: block;
  }

  .article :global(.znc table) {
    max-width: 100%;
    overflow-x: auto;
    display: block;
  }

  .article :global(.znc td),
  .article :global(.znc th) {
    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
  }

  .article :global(.znc pre) {
    max-width: 100%;
    overflow-x: auto;
  }

  .article :global(.znc iframe) {
    max-width: 100%;
  }

  .article :global(.znc code) {
    word-break: break-all;
    overflow-wrap: anywhere;
  }

  .article :global(.znc a) {
    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
  }

  .article :global(.znc p),
  .article :global(.znc li),
  .article :global(.znc h1),
  .article :global(.znc h2),
  .article :global(.znc h3),
  .article :global(.znc h4),
  .article :global(.znc h5),
  .article :global(.znc h6) {
    overflow-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
  }

  /* Mobile TOC Wrapper */
  .mobile-toc-wrapper {
    margin-bottom: 2rem;
  }

  /* Hide mobile TOC on desktop */
  @media (min-width: 1081px) {
    .mobile-toc-wrapper {
      display: none;
    }
  }

  /* TOC Sidebar */
  .toc-sidebar {
    position: sticky;
    top: 1.5rem;
    max-height: calc(100vh - 3rem);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: #d0d0d0 transparent;
  }

  .toc-sidebar::-webkit-scrollbar {
    width: 4px;
  }

  .toc-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }

  .toc-sidebar::-webkit-scrollbar-thumb {
    background: #d0d0d0;
    border-radius: 2px;
  }

  /* Responsive: hide TOC on smaller screens */
  @media (max-width: 1080px) {
    .article-page.has-toc {
      display: block;
      max-width: 800px;
    }

    .toc-sidebar {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .article-page {
      padding: 0 0.75rem;
    }

    .article {
      padding: 1.5rem;
    }

    .article-header h1 {
      font-size: 1.75rem;
    }

    .article-meta {
      font-size: 0.85rem;
      gap: 0.75rem;
    }

    .category {
      font-size: 0.8rem;
    }

    .topic {
      font-size: 0.8rem;
    }

    .target-category {
      font-size: 0.8rem;
    }
  }

  @media (max-width: 480px) {
    .article-page {
      padding: 0 0.5rem;
    }

    .article {
      padding: 1.25rem;
      border-radius: 4px;
    }

    .article-header {
      padding-bottom: 1rem;
      margin-bottom: 1.5rem;
    }

    .article-header h1 {
      font-size: 1.5rem;
      line-height: 1.4;
      margin-bottom: 0.75rem;
    }

    .article-meta {
      font-size: 0.8rem;
      gap: 0.5rem;
    }

    .category {
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
    }

    .topics {
      gap: 0.4rem;
      margin-top: 0.75rem;
    }

    .topic {
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
    }

    .target-category {
      padding: 0.2rem 0.6rem;
      font-size: 0.75rem;
    }
  }

</style>
