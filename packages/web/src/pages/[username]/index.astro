---
import BaseLayout from '../../layouts/BaseLayout.astro';
import UserArticleList from '../../islands/UserArticleList';
import UserProfileCard from '../../islands/UserProfileCard';

const { username } = Astro.params;
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8787';

// Get session cookie from request to check if viewing own profile
const cookie = Astro.request.headers.get('cookie') || '';

// Fetch user data, stats, and check current user
let user = null;
let stats = { totalArticles: 0, publishedArticles: 0, pendingArticles: 0, rejectedArticles: 0 };
let articles = [];
let isOwner = false;
let isLoggedIn = false;
let followStatus = { isFollowing: false, followerCount: 0, followingCount: 0 };
let error = null;

try {
  // Fetch user, stats, and articles in parallel
  const [userRes, statsRes, articlesRes, authRes] = await Promise.all([
    fetch(`${API_URL}/users/${username}`),
    fetch(`${API_URL}/users/${username}/stats`),
    fetch(`${API_URL}/users/${username}/articles`),
    fetch(`${API_URL}/auth/me`, { headers: { Cookie: cookie } }),
  ]);

  if (userRes.ok) {
    user = await userRes.json();
  } else {
    error = 'ユーザーが見つかりません';
  }

  if (statsRes.ok) {
    const data = await statsRes.json();
    stats = data.stats || stats;
  }

  if (articlesRes.ok) {
    const data = await articlesRes.json();
    articles = data.articles || [];
  }

  if (authRes.ok) {
    const authData = await authRes.json();
    isOwner = authData.username === username;
    isLoggedIn = true;
  }

  // Fetch follow status after we have the user data
  if (user) {
    const followStatusRes = await fetch(
      `${API_URL}/follows/${user.id}/status`,
      { headers: { Cookie: cookie } }
    );
    if (followStatusRes.ok) {
      followStatus = await followStatusRes.json();
    }
  }
} catch (err) {
  error = 'ユーザー情報の取得に失敗しました';
}

if (error || !user) {
  return Astro.redirect('/404');
}
---

<BaseLayout title={`${user.displayName} (@${user.username}) - Auth Vault`}>
  <div class="container">
    <div class="profile-section">
      <UserProfileCard
        user={user}
        stats={stats}
        isOwner={isOwner}
        followStatus={followStatus}
        isLoggedIn={isLoggedIn}
        apiUrl={API_URL}
        client:load
      />
    </div>

    <section class="articles-section">
      <h2>記事一覧</h2>
      <UserArticleList articles={articles} username={username} client:load />
    </section>
  </div>
</BaseLayout>

<style>
  .container {
    max-width: 800px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .profile-section {
    margin-bottom: 2rem;
  }

  .articles-section h2 {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
  }

  @media (max-width: 768px) {
    .container {
      padding: 0 0.75rem;
    }

    .profile-section {
      margin-bottom: 1.5rem;
    }

    .articles-section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }
  }

  @media (max-width: 480px) {
    .container {
      padding: 0 0.5rem;
    }

    .profile-section {
      margin-bottom: 1.25rem;
    }

    .articles-section h2 {
      font-size: 1.1rem;
      margin-bottom: 0.75rem;
    }
  }
</style>
